<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:fb="http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Camera and Video Control with HTML5 Example</title>
    <meta name="description" content="Access the desktop camera and video using HTML, JavaScript, and Canvas.  The camera may be controlled using HTML5 and getUserMedia." />
    <script type="text/javascript" src="./lib/zxing.js"></script>

    <style>
        video { border: 1px solid #ccc; display: block; margin: 0 0 20px 0; }
        canvas { margin-top: 20px; border: 10px solid #ccc; display: block; }
        .pass {
            border-color: darkgreen;
        }
        .fail {
            border-color: darkmagenta;
        }
    </style>
</head>
<body>

<!--
    Ideally these elements aren't created until it's confirmed that the
    client supports video/camera, but for the sake of illustrating the
    elements involved, they are created with markup (not JavaScript)
-->
<select id='source'></select>
<video id="video" width="640" height="480" autoplay></video>
<canvas id="canvas" width="640" height="480"></canvas>
<textarea style='height:480px;width:480px;'></textarea>
<ol id='log' reversed></ol>

<script>

(function(){
    let orig = console.error;
    let log = document.querySelector('#log');
    log.style.color = 'white';
    console.error = (msg)=>{
        orig(msg);
        let li = document.createElement('li');
        li.textContent = msg;
        li.style.backgroundColor = 'darkred';
        log.prepend(li);
    };
})();

// Put event listeners into place
window.addEventListener("load", async ()=>{
    // Grab elements, create settings, etc.
    const codeReader = new ZXing.BrowserDatamatrixCodeReader()
    const logarea = document.querySelector('textarea');
    let sources = document.querySelector("#source");
    let canvas = document.getElementById('canvas');
    let context = canvas.getContext('2d');
    let video = document.getElementById('video');
    let mediaConfig =  { 
        video: {
            facingMode: 'environment'
        }, 
        audio: false, 
    };
    let errBack = function(e) {
        console.log('An error has occurred!', e)
    };
    function snap(){
        try{
            decode();
        }
        finally{
            setTimeout(snap, 1000);
        }
    }
    async function decode(){
        context.drawImage(video, 0, 0, 640, 480);
        let data = context.getImageData(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < data.data.length; i+=4 ) {
            let avg = 0;
            avg += data.data[i];
            avg += data.data[i+1];
            avg += data.data[i+2];
            avg /= 3;
            data.data[i+0] = avg;
            data.data[i+1] = avg;
            data.data[i+2] = avg;
        }
        context.putImageData(data, 0, 0);
        let url = canvas.toDataURL('image/png',1.0);
        let img = document.createElement('img');
        img.style.filter = 'grayscale(1)';
        img.src = url;
        //img.src = './sample.png';
        canvas.classList.remove('pass');
        canvas.classList.remove('fail');
        try{
            result = await codeReader.decodeFromImage(img);
            canvas.classList.add('pass');
            console.log(result);
            logarea.textContent = result;
        }
        catch(err){
            canvas.classList.add('fail');
            console.error(err);
        }
    };

    const devices = await navigator.mediaDevices.enumerateDevices();
    sources.innerHTML = devices
        .filter(d=>{
            let rtn = d.label.trim();
            rtn = rtn !== '';
            return rtn ;
        })
        .map((d)=>{
            let opt = `<option value='${d.deviceId}'>${d.label}</option>`;
            return opt;
        })
        .join('\n')
        ;
    function changeSource(){
        //if(!video.srcObject) return;
        //for(let track of video.srcObject.getTracks()){
        //    track.stop();
        //}
        navigator.mediaDevices.getUserMedia(mediaConfig).then(function(stream) {
            video.srcObject = stream;
            video.play();
        });
    }
    sources.addEventListener('change',changeSource);
    changeSource();

    // Trigger photo take
    snap();
});

</script>
</main>
</body>
</html>
